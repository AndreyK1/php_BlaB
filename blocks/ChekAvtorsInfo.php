<?						//обработка информации об авторах (сколько речей у автора, сколько не просмотренных речей без флага рерайт-т.е. просмотр, дата последней просмотренной речи) и добавление всей этой инфы к автору						// команда для крона  10	4	*	*	*	cd /var/www/vhosts/probey.net/BlaBase/blocks/ ; /usr/bin/php /var/www/vhosts/probey.net/BlaBase/blocks/Create_sitemap.php//	header('Content-Type: text/html; charset=utf-8');//собираем всю информацию об защедщих на сайт//ini_set("max_execution_time", "60");														//подключаем БД				include_once('startup.php');						//include_once('../startup.php'); //если не подключено				startup();  echo "ggg";			 				//пробегаемся по всем авторам				//$query="SELECT * FROM News_foreign ";				$query ="SELECT * FROM Speech_Who "; 						$result = mysql_query($query) or die(mysql_error());				//var_dump($result);				//if (!$result) die("косяк");				//$row = mysql_fetch_assoc($result);				//var_dump($row);				//echo $row['0'];				while($row = mysql_fetch_assoc($result)){					//var_dump($row);					//echo $row['0'];					if(count($row)>0){						$whoInfo = '';						//echo $row['0'];						//подсчитываем все его речи						$query =   "SELECT count(*) FROM Speech_from_News WHERE id_who = '".$row['id']."'"; 						$result1 = mysql_query($query);						$row1 = mysql_fetch_assoc($result1);						//var_dump($row1);						if(count($row1)>0){							$whoInfo = $row1['count(*)'];						}						//достаем  его последнюю посмотренную речь 						$query =   "SELECT * FROM Speech_from_News WHERE id_who = '".$row['id']."' AND  rerait = '1' ORDER BY id DESC LIMIT 1  "; 						$result1 = mysql_query($query);						$row1 = mysql_fetch_assoc($result1);						//var_dump($row1);						$id_last = 0;						$dateL = "0";						if(count($row1)>0){							//							$id_last = $row1['id'];							$date = explode(' ',$row1['date']);							$dateL = $date['0'];													}						$whoInfo .="|".$dateL;												//подсчитываем сколько у него непросмотренных речей после последней просмотренной						$query =   "SELECT count(*) FROM Speech_from_News WHERE id_who = '".$row['id']."' AND  rerait = '0' AND id>'".$id_last."' "; 						$result1 = mysql_query($query);						$row1 = mysql_fetch_assoc($result1);						//var_dump($row1);						$new = 0;						if(count($row1)>0){							//							$new = $row1['count(*)'];									}												$whoInfo .="|".$new;																									//записываем автору сколько у него речей							//echo $row['0'];							$query = "UPDATE Speech_Who SET LastSpeechInfo = '".$whoInfo."'  WHERE id='".$row['id']."'";							$result2 = mysql_query($query) or die(mysql_error());						}				}  	//пересчитываем структуру авторов и закидываем в БД	$_GET['avtor'] ='all';	include_once('MakeStructAvtArr.php');	   die();	 				//достаем дату последней добавленной речи				$query =   "SELECT MAX(date) AS 'Max_Date'  FROM Speech_from_News"; 						$result = mysql_query($query);				$row = mysql_fetch_assoc($result);					$lsd = explode(' ',$row['Max_Date']);				$lsd = $lsd[0];								//var_dump($lsd);				//die();				// создаем новый xml документ				$dom = new DOMDocument('1.0', 'UTF-8');				$dom->formatOutput = true;					//создаем главные страницы					//date('Y-m-d H:i:s', time() - 60  * 20);							$pages = array(					array(							'url' => $ServerUrl.'/',							'changefreq' => 'daily',							'priority' => '1.00',							'lastmod' => $lsd						),					array(							'url' => $ServerUrl.'/PersonsStruct.php?avtor=all',							'changefreq' => 'daily',							'priority' => '0.9',							'lastmod' => $lsd						),					);										//Получаем все авторов речей					$autors = getAllAutorsOfSpeech();							//Получаем все речи авторов (по 5 штук)					$speech = getAllSpeechPages();								// и добавляем их в массив										$pages = array_merge($pages,$autors); 					$pages = array_merge($pages,$speech); 										//вывод на экран количества страниц в sitemap					echo " Sitemap file was created. It contains ".sizeof($pages)." pages";					//var_dump(sizeof($pages));										$SITEMAP_NS = 'http://www.sitemaps.org/schemas/sitemap/0.9';					$SITEMAP_NS_XSD = 'http://www.sitemaps.org/schemas/sitemap/0.9/sitemap.xsd';					// ...and urlset (root) element					$urlSet = $dom->createElementNS($SITEMAP_NS, 'urlset');					$dom->appendChild($urlSet);					$urlSet->setAttributeNS('http://www.w3.org/2000/xmlns/' ,						'xmlns:xsi',						'http://www.w3.org/2001/XMLSchema-instance');					$urlSet->setAttributeNS('http://www.w3.org/2001/XMLSchema-instance',						'schemaLocation',						$SITEMAP_NS . ' ' . $SITEMAP_NS_XSD);						//пробигаемся по страницам и закидываем их в ДОМ						foreach($pages as $page) {							$url = $page['url'];							// create url node for this page							$urlNode = $dom->createElementNS($SITEMAP_NS, 'url');							$urlSet->appendChild($urlNode);							// put url in 'loc' element							$urlNode->appendChild($dom->createElementNS(								$SITEMAP_NS,								'loc', $url));							$urlNode->appendChild(								$dom->createElementNS(									$SITEMAP_NS,									'changefreq',									$page['changefreq'])							);							$urlNode->appendChild(								$dom->createElementNS(									$SITEMAP_NS,									'priority',									$page['priority'])							);							$urlNode->appendChild(								$dom->createElementNS(									$SITEMAP_NS,									'lastmod',									$page['lastmod'])							);						}					$xml = $dom->saveXML();										//удаляем предыдуший файл					unlink('../sitemap.xml');					//сохраняем файл sitemap.xml на диск					file_put_contents('../sitemap.xml' , $xml);											//Получаем все темы,форумы,страницы из БД	function getAll($table){			if($table == 'Speech_Who'){					$query = "SELECT max(date) as date,id_who FROM Speech_from_News GROUP BY id_who ";					}elseif($table == 'Speech_from_News'){					$query = "SELECT id,date FROM Speech_from_News ORDER BY id";					 }			 			 			$result = mysql_query($query);// or die(mysql_error());			//return mysql_fetch_assoc($result);			if (!$result)				die(mysql_error().$query);						// Извлечение из БД.			$n = mysql_num_rows($result);			$arr = array();							for ($i = 0; $i < $n; $i++)			{				$row = mysql_fetch_assoc($result);						$arr[] = $row;			}			return $arr;	}				//функция, которая получает массив всех авторов речей с датой последжней речи для sitemap	function getAllAutorsOfSpeech(){		$arr = getAll('Speech_Who');//return $arr;				//вытаскиваем переменную $numof из файла (сколько коментов на странице)		include('../variables.php');		for($i=0; $i<count($arr); $i++){			$arr[$i]['url'] = $UrlOfServer.'/SpeechWind.php?avtor='.$arr[$i]['id_who']; //soobsh&id_soobsh=23				 $time = explode(" ",$arr[$i]['date']);			$arr[$i]['lastmod']	= $time['0'];			$arr[$i]['changefreq']	= 'daily';			$arr[$i]['priority']	= '0.8';		}		return $arr;	}			//функция, которая берет все речи из базы и делает ссылки по 5 речей	function getAllSpeechPages(){		$arr = getAll('Speech_from_News');//return $arr;				//вытаскиваем переменную $numof из файла (сколько коментов на странице)		include('../variables.php');		$k=0;		$idB='';		$idE='';		$arrRet = array();		for($i=0; $i<count($arr); $i++){			$k++; if($k>5){ $k=1;}			if($k==1){ $idB=$arr[$i]['id'];}//если это первый номер из пяти, то записываем его id (речи)			if($k==5){ //если это последний номер из пяти, то записываем его id (речи) и pfgbcsdftv ccskre				$idE=$arr[$i]['id'];				$IdSBEnd = $idB."|".$idE;								$arrRet[$i]['url'] = $UrlOfServer.'/SpeechWind.php?IdSBEnd='.$IdSBEnd; //soobsh&id_soobsh=23					 $time = explode(" ",$arr[$i]['date']);				$arrRet[$i]['lastmod']	= $time['0'];				$arrRet[$i]['changefreq']	= 'daily';				$arrRet[$i]['priority']	= '0.8';			}		}		return $arrRet;	}				//$arr = getAllUsersPages();		//var_dump($arr);				//пересчитываем структуру авторов и закидываем в БД		$_GET['avtor'] ='all';		include_once('../MakeStructAvtArr.php');				?>