<?						// команда для крона  10	4	*	*	*	cd /var/www/vhosts/probey.net/BlaBase/blocks/ ; /usr/bin/php /var/www/vhosts/probey.net/BlaBase/blocks/Create_sitemap.php																//адрес сайта				$ServerUrl = 'http://BlaBase.ru';							//подключаем БД				include_once('../startup.php');						//include_once('../startup.php'); //если не подключено				startup();								//достаем дату последней добавленной речи				$query =   "SELECT MAX(date) AS 'Max_Date'  FROM Speech_from_News"; 						$result = mysql_query($query);				$row = mysql_fetch_assoc($result);					$lsd = explode(' ',$row['Max_Date']);				$lsd = $lsd[0];								//var_dump($lsd);				//die();				// создаем новый xml документ				$dom = new DOMDocument('1.0', 'UTF-8');				$dom->formatOutput = true;					//создаем главные страницы					//date('Y-m-d H:i:s', time() - 60  * 20);							$pages = array(					array(							'url' => $ServerUrl.'/',							'changefreq' => 'daily',							'priority' => '1.00',							'lastmod' => $lsd						),					array(							'url' => $ServerUrl.'/PersonsStruct.php?avtor=all',							'changefreq' => 'daily',							'priority' => '0.9',							'lastmod' => $lsd						)					);										//Получаем все авторов речей					$autors = getAllAutorsOfSpeech();												echo " autors file was created. It contains ".sizeof($autors)." pages";					//Получаем все речи авторов (по 5 штук)					$speech = getAllSpeechPages();					echo " speech file was created. It contains ".sizeof($speech)." pages";					// и добавляем их в массив										$pages = array_merge($pages,$autors); 					$pages = array_merge($pages,$speech); 										//вывод на экран количества страниц в sitemap					echo " Sitemap file was created. It contains ".sizeof($pages)." pages";					//var_dump(sizeof($pages));										$SITEMAP_NS = 'http://www.sitemaps.org/schemas/sitemap/0.9';					$SITEMAP_NS_XSD = 'http://www.sitemaps.org/schemas/sitemap/0.9/sitemap.xsd';					// ...and urlset (root) element					$urlSet = $dom->createElementNS($SITEMAP_NS, 'urlset');					$dom->appendChild($urlSet);					$urlSet->setAttributeNS('http://www.w3.org/2000/xmlns/' ,						'xmlns:xsi',						'http://www.w3.org/2001/XMLSchema-instance');					$urlSet->setAttributeNS('http://www.w3.org/2001/XMLSchema-instance',						'schemaLocation',						$SITEMAP_NS . ' ' . $SITEMAP_NS_XSD);						//пробигаемся по страницам и закидываем их в ДОМ						foreach($pages as $page) {							$url = $page['url'];							// create url node for this page							$urlNode = $dom->createElementNS($SITEMAP_NS, 'url');							$urlSet->appendChild($urlNode);							// put url in 'loc' element							$urlNode->appendChild($dom->createElementNS(								$SITEMAP_NS,								'loc', $url));							$urlNode->appendChild(								$dom->createElementNS(									$SITEMAP_NS,									'changefreq',									$page['changefreq'])							);							$urlNode->appendChild(								$dom->createElementNS(									$SITEMAP_NS,									'priority',									$page['priority'])							);							$urlNode->appendChild(								$dom->createElementNS(									$SITEMAP_NS,									'lastmod',									$page['lastmod'])							);						}					$xml = $dom->saveXML();										//удаляем предыдуший файл					unlink('../sitemap.xml');					//сохраняем файл sitemap.xml на диск					file_put_contents('../sitemap.xml' , $xml);											//Получаем все темы,форумы,страницы из БД	function getAll($table){			if($table == 'Speech_Who'){					$query = "SELECT max(date) as date,id_who,count(*) as num  FROM Speech_from_News WHERE id_who<2800 GROUP BY id_who  ";					}elseif($table == 'Speech_from_News'){					$query = "SELECT id,date FROM Speech_from_News ORDER BY id";					 }			 			 //echo $query;			$result = mysql_query($query);// or die(mysql_error());			//return mysql_fetch_assoc($result);			if (!$result)				die(mysql_error().$query);						// Извлечение из БД.			$n = mysql_num_rows($result);			$arr = array();							for ($i = 0; $i < $n; $i++)			{				$row = mysql_fetch_assoc($result);				/*if($table == 'Speech_Who'){					if($row['id_who'] >2800){ break; } //ограничиваем авторов, чтобы в дальнейшем поиск был по речам				}	*/							$arr[] = $row;			}			return $arr;	}				//функция, которая получает массив всех авторов речей с датой последжней речи для sitemap	function getAllAutorsOfSpeech(){		$arr = getAll('Speech_Who');//return $arr;				//вытаскиваем переменную $numof из файла (сколько коментов на странице)		include('../variables.php');				echo "num-".$num; //кол-во речей на странице				$newarr = array();		for($i=0; $i<count($arr); $i++){							$arr[$i]['url'] = $UrlOfServer.'/SpeechWind.php?avtor='.$arr[$i]['id_who']; //.'-'.$arr[$i]['num']; //soobsh&id_soobsh=23				$time = explode(" ",$arr[$i]['date']);				$arr[$i]['lastmod']	= $time['0'];				$arr[$i]['changefreq']	= 'daily';				$arr[$i]['priority']	= '0.8';				 					}		return $arr;	}			//функция, которая берет все речи из базы и делает ссылки по 5 речей	function getAllSpeechPages(){		$arr = getAll('Speech_from_News');//return $arr;				//вытаскиваем переменную $numof из файла (сколько коментов на странице)		include('../variables.php');		$k=0;		$idB='';		$idE='';		$arrRet = array();		for($i=0; $i<count($arr); $i++){			$k++; if($k>5){ $k=1;}			if($k==1){ $idB=$arr[$i]['id'];}//если это первый номер из пяти, то записываем его id (речи)			if($k==5){ //если это последний номер из пяти, то записываем его id (речи) и pfgbcsdftv ccskre				$idE=$arr[$i]['id'];				$IdSBEnd = $idB."|".$idE;								$arrRet[$i]['url'] = $UrlOfServer.'/SpeechWind.php?IdSBEnd='.$IdSBEnd; //soobsh&id_soobsh=23					 $time = explode(" ",$arr[$i]['date']);				$arrRet[$i]['lastmod']	= $time['0'];				$arrRet[$i]['changefreq']	= 'daily';				$arrRet[$i]['priority']	= '0.8';			}		}		return $arrRet;	}				//$arr = getAllUsersPages();		//var_dump($arr);					?>